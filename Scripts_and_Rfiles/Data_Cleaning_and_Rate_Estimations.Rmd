---
title: "Data Cleaning and Rate Calculations"
output: html_document
date: '2022-09-14'
---

#Install package in case they are not in installed
```{r}
rm(list=ls())

if ("devtools" %in% rownames(installed.packages()) == 'FALSE') install.packages('devtools') 
library(devtools)
if ("segmented" %in% rownames(installed.packages()) == 'FALSE') install.packages('segmented') 
if ("plotrix" %in% rownames(installed.packages()) == 'FALSE') install.packages('plotrix') 
if ("gridExtra" %in% rownames(installed.packages()) == 'FALSE') install.packages('gridExtra') 
if ("LoLinR" %in% rownames(installed.packages()) == 'FALSE') install_github('colin-olito/LoLinR') 
if ("lubridate" %in% rownames(installed.packages()) == 'FALSE') install.packages('lubridate') 
if ("chron" %in% rownames(installed.packages()) == 'FALSE') install.packages('chron') 
if ("plyr" %in% rownames(installed.packages()) == 'FALSE') install.packages('plyr') 
if ("dplyr" %in% rownames(installed.packages()) == 'FALSE') install.packages('dplyr') 
```

#Load necessary package
```{r}
library("ggplot2")
library("segmented")
library("plotrix")
library("gridExtra")
library("LoLinR")
library("lubridate")
library("chron")
library('plyr')
library('dplyr')
library('tidyverse')
library('dplyr')
library('tidyr')
library(readxl)
library(stringr)
library(lattice)
```


```{r}
# get the file path

RPROJ <- list(hcapone2 = normalizePath(getwd()))
attach(RPROJ)
path.p<-file.path(hcapone2, 'Algae_PreSens_respfiles')
path.p
```

#######Data cleaning & NP/R rate estimations######


#Make a list of the respirometry files
```{r}
# bring in the oxygen files

file.names<-basename(list.files(path = path.p, pattern = "csv$", recursive = TRUE)) #list all csv file names in the folder and subfolders
file.names

#basename above removes the subdirectory name from the file
#add file names that include the subdirectory name (note, these are the same for this example, but I often have lots of subfolders for different Runs)

file.names<-basename(list.files(path = path.p, pattern = "csv$", recursive = TRUE))
file.names.full<-list.files(path = path.p, pattern = "csv$", recursive = TRUE) #list all csv file names in the folder and subfolders

file.names.full
```

#generate an empty 3 column dataframe with specific column names
```{r}

#generate a 3 column dataframe with specific column names
Photo.R<- data.frame(matrix(NA, nrow=length(file.names), ncol=4))
colnames(Photo.R) <- c("ID","Intercept", "umol.L.sec","Temp.C")
View(Photo.R)

#Photo.R<-read.csv(file=paste0(path.p,"/../Photo.R.csv"), header = T) 

```

#Loading the file for metadata
```{r}

#Load Sample Info/your respiration data file, with all the times, etc.
#Sample.Info <- read.csv(file=paste0(path.p,"/../Panama MetaData/Nubbin_Sample_Info_T0_Panama_QC.csv"), header=T) #read sample.info data
#Sample.Info <- read.csv(file=paste0(path.p,"/../metadata.csv"), header=T) #read sample.info data
Sample.Info <- read.csv(file=paste0(path.p,"/../Macroalgae_metadata.csv"), header=T) 
View(Sample.Info)
```

# make start and stop times real times
```{r}

Sample.Info$Start.time <- as.POSIXct(Sample.Info$Start.time,format="%H:%M:%S", tz = "") #convert time from character to time
Sample.Info$Stop.Time <- as.POSIXct(Sample.Info$Stop.Time,format="%H:%M:%S", tz = "") #convert time from character to time
#Add names for photosynthesis or respiration for for loop 
#PR<-c('Photo','Resp')

```


#Calculating O2 intake for every file in list
```{r}

for(i in 1:length(file.names.full)) { # for every file in list calculate O2 uptake or release rate and add the data to the Photo.R dataframe

  #find the lines in sample info that have the same file name that is being brought in
  FRow<-which(Sample.Info$ID==strsplit(file.names[i],'.csv'))

  # read in the O2 data one by one
  Photo.Data1 <-read.csv(file.path(path.p,file.names.full[i]), skip = 1, header=T) # skips the first line
  Photo.Data1  <- Photo.Data1[,c("Time","Value","Temp")] #subset columns of interest
  Photo.Data1$Time <- as.POSIXct(Photo.Data1$Time,format="%H:%M:%S", tz = "") #convert time from character to time
  Photo.Data1 <- na.omit(Photo.Data1) #omit NA from data frame



# clean up some of the data
    n<-dim(Photo.Data1)[1] # length of full data
    Photo.Data1 <-Photo.Data1[15:(n-3),] #start at data point ~15s in to avoid excess noise from start of run and remove last 3 lines containing text

    n<-dim(Photo.Data1)[1] #list length of trimmed data
    Photo.Data1$sec <- 1:n #set seconds by one from start to finish of run in a new column
    #Save plot prior to and after data thinning to make sure thinning is not too extreme
    rename <- sub(".csv","", file.names[i]) # remove all the extra stuff in the file name

  pdf(paste0("Output/",rename,"thinned.pdf")) # open the graphics device




    par(omi=rep(0.3, 4)) #set size of the outer margins in inches
    par(mfrow=c(1,2)) #set number of rows and columns in multi plot graphic

    plot(Value ~ sec, data=Photo.Data1 , xlab='Time (seconds)', ylab=expression(paste(' O'[2],' (',mu,'mol/L)')), type='n', axes=FALSE) #plot (empty plot to fill) data as a function of time

    usr  <-  par('usr') # extract the size of the figure margins

    rect(usr[1], usr[3], usr[2], usr[4], col='grey90', border=NA) # put a grey background on the plot

    whiteGrid() # make a grid
    box() # add a box around the plot

    points(Photo.Data1 $Value ~ Photo.Data1 $sec, pch=16, col=transparentColor('dodgerblue2', 0.6), cex=1.1)

    axis(1) # add the x axis
    axis(2, las=1) # add the y-axis

# Thin the data to make the code run faster
    Photo.Data.orig<-Photo.Data1 #save original unthinned data
    Photo.Data1 <-  thinData(Photo.Data1 , by=15)$newData1 #thin data by every 15 points for all the O2 values

    Photo.Data1$sec <- as.numeric(rownames(Photo.Data1 )) #maintain numeric values for time

    Photo.Data1$Temp<-NA # add a new column to fill with the thinned data

    Photo.Data1$Temp <-  thinData(Photo.Data.orig, xy = c(1,3), by=15)$newData1[,2] #thin data by every 15 points for the temp values

#plot the thinned data

  plot(Value ~ sec, data=Photo.Data1 , xlab='Time (seconds)', ylab=expression(paste(' O'[2],' (',mu,'mol/L)')), type='n', axes=FALSE)
#plot thinned data
  usr  <-  par('usr')
  rect(usr[1], usr[3], usr[2], usr[4], col='grey90', border=NA)
  whiteGrid()
  box()
  points(Photo.Data1 $Value ~ Photo.Data1 $sec, pch=16, col=transparentColor('dodgerblue2', 0.6), cex=1.1)
  axis(1)
  axis(2, las=1)
    ##Olito et al. 2017: It is running a bootstrapping technique and calculating the rate based on density
    #option to add multiple outputs method= c("z", "eq", "pc")
    Regs  <-  rankLocReg(xall=Photo.Data1$sec, yall=Photo.Data1$Value, alpha=0.5, method="pc", verbose=TRUE)
    # add the regression data
    plot(Regs)
    dev.off()

    # fill in all the O2 consumption and rate data
    Photo.R[i,2:3] <- Regs$allRegs[1,c(4,5)] #inserts slope and intercept in the dataframe
    Photo.R[i,1] <- rename #stores the file name in the Date column
    Photo.R[i,4] <- mean(Photo.Data1$Temp, na.rm=T)  #stores the Temperature in the Temp.C column
    #Photo.R[i,5] <- PR[j] #stores whether it is photosynthesis or respiration

    # rewrite the file every time... I know this is slow, but it will save the data that is already run
}

write.csv(Photo.R, 'Output/Photo.R.csv')
```


#read in Photo.R file so you don't need to run entire for loop again
```{r}
Photo.R <- read.csv('Output/Photo.R.csv')
Photo.R <- na.omit(Photo.R)

Photo.R$ID <- gsub( '.{3}$', '', Photo.R$ID)

#Photo.R$ID <- substr(Photo.R$ID, 1 , nchar(Photo.R$ID - 3))
View(Photo.R)
```

#Joint metadata with Photo.R
```{r}
Photo.R_full<-left_join(Photo.R, Sample.Info)
View(Photo.R_full) 
```

# Calculate P and R rate
```{r}
#Convert sample volume to mL

Photo.R_full$Volume <- Photo.R_full$Volume/1000 #calculate volume

#Account for chamber volume to convert from umol L-1 s-1 to umol s-1. This standardizes across water volumes (different because of algae size) and removes per Liter 
Photo.R_full$umol.sec <- Photo.R_full$umol.L.sec*Photo.R_full$Volume

View(Photo.R_full)
```

#Account for blank rate by temperature
```{r}

Photo.R_full <- Photo.R_full %>%
  mutate_if(sapply(., is.character), as.factor)

# make the blank column a factor
#Photo.R_full$Blank<-ifelse(Photo.R_full$Ambient_Nutrient=='Blank', 1,0)
Photo.R_full$Blank<-as.factor(Photo.R_full$Blank)
View(Photo.R_full)


#write.csv(Photo.R_full, 'Output/Photo.R_full.csv') 
```

#aggregate certain columns together for easier viewing
```{r}
photo.blnk <- aggregate(umol.sec ~ Species*Temp.Cat*Light_Dark*Run*Blank, data=Photo.R_full, mean)
View(photo.blnk)
```

# pull out only the blanks
```{r}
#photo.blnk<-photo.blnk[photo.blnk$Species=='BK',]
photo.blnk<-photo.blnk[photo.blnk$Blank==1,]

#remove the species column and join with the full data set?
photo.blnk$Species<-NULL

# remove the blank column
photo.blnk$Blank<-NULL

View(photo.blnk)

```

# rename the blank rate
```{r}
colnames(photo.blnk)[4]<-'blank.rate' 
#write.csv(photo.blnk, 'Output/photo.blnk.csv') 
```

# join the blank data with the rest of the data
```{r}
Photo.R_full.blnk<-left_join(Photo.R_full, photo.blnk)
View(Photo.R_full.blnk)

```

# subtract the blanks
```{r}
Photo.R_full.blnk$umol.sec.corr<-Photo.R_full.blnk$umol.sec-Photo.R_full.blnk$blank.rate
```

# Normalize to organic biomass (ash free dry weight)
```{r}
Photo.R_full.blnk$umol.cm2.hr <- (Photo.R_full.blnk$umol.sec.corr*3600)/Photo.R_full.blnk$Dry.weight #mmol cm-2 hr-1

# remove NAs and blanks
Photo.R_full.blnk<-Photo.R_full.blnk[Photo.R_full.blnk$Blank==0,]

View(Photo.R_full.blnk)
```

#Export back into R
```{r}
Photo.RNP <- read.csv('Output/Photo.RNPP.csv')

Photo.RNP <- Photo.RNP %>% 
  mutate(rate.type = recode_factor(rate.type, `NP` = "Net Photosynthesis", `R` = "Respiration"))

#change control and enriched names
Photo.RNP <- Photo.RNP %>% 
  mutate(Ambient_Nutrient = recode_factor(Ambient_Nutrient, `Ambient` = "Ambient", `Nutrient` = "Nutrient"))

View(Photo.RNP)
```



#######Raw data curve plots based on rate estimations########

#Combine NP & R regressions into ggplot by Genus*Treatment
```{r}
####Ulva####

library(ggplot2)

# Filter data for Ulva net photosynthesis
ulv_np <- subset(Photo.RNP, Species == "Ulv" & rate.type == "Net Photosynthesis")

# Filter data for Ulva respiration
ulv_r <- subset(Photo.RNP, Species == "Ulv" & rate.type == "Respiration")

# Create plot for both net photosynthesis and respiration
ulv <- ggplot(mapping = aes(x = Temp.C, y = log.rate, color = paste(rate.type, Ambient_Nutrient, sep = " x "))) +
  geom_point(data = ulv_np, aes(fill = paste(rate.type, Ambient_Nutrient, sep = " x ")), size = 1.75, position = position_dodge(0.5), show.legend = FALSE) +
  geom_smooth(data = ulv_np, aes(fill = paste(rate.type, Ambient_Nutrient, sep = " x ")), se = TRUE, span = 0.5, alpha = 0.25, show.legend = FALSE) +
  geom_point(data = ulv_r, aes(fill = paste(rate.type, Ambient_Nutrient, sep = " x ")), size = 1.75, position = position_dodge(0.5), show.legend = FALSE) +
  geom_smooth(data = ulv_r, aes(fill = paste(rate.type, Ambient_Nutrient, sep = " x ")), se = TRUE, span = 0.9, linetype = "solid", show.legend = FALSE) +
  scale_fill_manual(values = c('seagreen2', 'seagreen', 'deepskyblue1', 'deepskyblue4')) +
  labs(x = "Temperature (ºC)", y = "") +
  theme_classic() +
  scale_x_continuous(limits = c(15, 43), expand = c(0, 0), breaks = seq(15, 40, by = 5)) +
  scale_y_continuous(expand = c(0, 0)) +
  scale_color_manual(values = c('seagreen2', 'seagreen', 'deepskyblue1', 'deepskyblue4'),
                     guide = guide_legend(title = "Treatment", title.position = "top", title.hjust = 0.5,
                                          override.aes = list(linetype = c("solid", "dashed", "solid", "dashed"),
                                                              fill = c('seagreen2', 'seagreen', 'deepskyblue1', 'deepskyblue4')),
                                          nrow = 2),
                     labels = c("Ambient Net Photosynthesis",
                                "Enriched Net Photosynthesis",
                                "Ambient Respiration",
                                "Enriched Respiration")) +
  theme(legend.text = element_text(size = 12),
        legend.title = element_text(size = 14), 
        axis.title.x = element_text(size = 20),
        axis.title.y = element_text(size = 20),
        axis.text.x = element_text(size =18, color = "black"), 
        axis.text.y = element_text(size = 18, color = "black"),
        plot.title = element_text(size = 23, face = "bold", hjust = -.15)) +
  scale_y_continuous(limits = c(0, 7.1), breaks = seq(0, 7, by = 1)) +
  ggtitle(expression(bold("d  ")~italic("Ulva")~plain("spp."))) +
  labs(y = "")

#print(ulv)



#Display the plot
ulv

```


```{r}
######Caulerpa######

library(ggplot2)


# Filter data for Caul net photosynthesis
caul_np <- subset(Photo.RNP, Species == "Caul" & rate.type == "Net Photosynthesis")

# Filter data for Caul respiration
caul_r <- subset(Photo.RNP, Species == "Caul" & rate.type == "Respiration")

# Create plot for both net photosynthesis and respiration
caul <- ggplot(mapping = aes(x = Temp.C, y = log.rate, color = paste(rate.type, Ambient_Nutrient, sep = " x "))) +
  geom_point(data = caul_np, aes(fill = paste(rate.type, Ambient_Nutrient, sep = " x ")), size = 1.75, position = position_dodge(0.5), show.legend = FALSE) +
  geom_smooth(data = caul_np, aes(fill = paste(rate.type, Ambient_Nutrient, sep = " x ")), se = TRUE, span = 0.9, alpha = 0.25, show.legend = FALSE) +
  geom_point(data = caul_r, aes(fill = paste(rate.type, Ambient_Nutrient, sep = " x ")), size = 1.75, position = position_dodge(0.5), show.legend = FALSE) +
  geom_smooth(data = caul_r, aes(fill = paste(rate.type, Ambient_Nutrient, sep = " x ")), se = TRUE, span = 1, linetype = "solid", show.legend = FALSE) +
  scale_fill_manual(values = c('seagreen2', 'seagreen', 'deepskyblue1', 'deepskyblue4')) +
  labs(x = "Temperature (ºC)", y = expression(Rate~(log~mu*mol~O[2]~g^-1~hr^-1))) +
  theme_classic() +
  scale_x_continuous(limits = c(15, 43), expand = c(0, 0), breaks = seq(15, 40, by = 5)) +
  scale_y_continuous(expand = c(0, 0)) +
  scale_color_manual(values = c('seagreen2', 'seagreen', 'deepskyblue1', 'deepskyblue4'),
                     guide = guide_legend(title = "Treatment Type", title.position = "top", title.hjust = 0.5,
                                          override.aes = list(linetype = c("solid", "dashed", "solid", "dashed"),
                                                              fill = c('seagreen2', 'seagreen', 'deepskyblue1', 'deepskyblue4')),
                                          nrow = 2),
                     labels = c("Ambient Net Photosynthesis",
                                "Enriched Net Photosynthesis",
                                "Ambient Respiration",
                                "Enriched Respiration")) +
  theme(legend.text = element_text(size = 12),
        legend.title = element_text(size = 14), 
        axis.title.x = element_text(size = 20),
        axis.title.y = element_text(size = 20),
        axis.text.x = element_text(size =18, color = "black"), 
        axis.text.y = element_text(size = 18, color = "black"),
        plot.title = element_text(size = 23, face = "bold", hjust = -.6)) +
  ggtitle(expression(bold("c  ")~italic("Caulerpa racemosa"))) +
  scale_y_continuous(limits = c(-0.21, 7.1), breaks = seq(0, 7, by = 1))

#Display the plot
caul

```

```{r}
######Pad######

library(ggplot2)


# Filter data for Pad net photosynthesis
pad_np <- subset(Photo.RNP, Species == "Pad" & rate.type == "Net Photosynthesis")

# Filter data for Pad respiration
pad_r <- subset(Photo.RNP, Species == "Pad" & rate.type == "Respiration")

# Create plot for both net photosynthesis and respiration
pad <- ggplot(mapping = aes(x = Temp.C, y = log.rate, color = paste(rate.type, Ambient_Nutrient, sep = " x "))) +
  geom_point(data = pad_np, aes(fill = paste(rate.type, Ambient_Nutrient, sep = " x ")), size = 1.75, position = position_dodge(0.5), show.legend = FALSE) +
  geom_smooth(data = pad_np, aes(fill = paste(rate.type, Ambient_Nutrient, sep = " x ")), se = TRUE, span = 1, alpha = 0.25, show.legend = FALSE) +
  geom_point(data = pad_r, aes(fill = paste(rate.type, Ambient_Nutrient, sep = " x ")), size = 1.75, position = position_dodge(0.5), show.legend = FALSE) +
  geom_smooth(data = pad_r, aes(fill = paste(rate.type, Ambient_Nutrient, sep = " x ")), se = TRUE, span = 0.8, linetype = "solid", show.legend = FALSE) +
  scale_fill_manual(values = c('seagreen2', 'seagreen', 'deepskyblue1', 'deepskyblue4')) +
  labs(x = " ", y = "") +
  theme_classic() +
  scale_x_continuous(limits = c(15, 43), expand = c(0, 0), breaks = seq(15, 40, by = 5)) +
  scale_y_continuous(expand = c(0, 0)) +
  scale_color_manual(values = c('seagreen2', 'seagreen', 'deepskyblue1', 'deepskyblue4'),
                     guide = guide_legend(title = "Treatment Type", title.position = "top", title.hjust = 0.5,
                                          override.aes = list(linetype = c("solid", "dashed", "solid", "dashed"),
                                                              fill = c('seagreen2', 'seagreen', 'deepskyblue1', 'deepskyblue4')),
                                          nrow = 2),
                     labels = c("Ambient Net Photosynthesis",
                                "Enriched Net Photosynthesis",
                                "Ambient Respiration",
                                "Enriched Respiration")) +
  theme(legend.text = element_text(size = 12),
        legend.title = element_text(size = 14), 
        axis.title.x = element_text(size = 20),
        axis.title.y = element_text(size = 20),
        axis.text.x = element_text(size =18, color = "black"), 
        axis.text.y = element_text(size = 18, color = "black"),
        plot.title = element_text(size = 23, face = "bold", hjust = -.15)) +
  scale_y_continuous(limits = c(-0.44, 7), breaks = seq(0, 7, by = 1)) +
  ggtitle(expression(bold("b  ")~italic("Padina")~plain("spp.")))

#Display the plot
pad

```

```{r}
######Grac (Ochtodes) ######

library(ggplot2)

# Filter data for Grac net photosynthesis
grac_np <- subset(Photo.RNP, Species == "Grac" & rate.type == "Net Photosynthesis")

# Filter data for Grac respiration
grac_r <- subset(Photo.RNP, Species == "Grac" & rate.type == "Respiration") 


# Create plot for both net photosynthesis and respiration
grac <- ggplot(mapping = aes(x = Temp.C, y = log.rate, color = paste(rate.type, Ambient_Nutrient, sep = " x "))) +
  geom_point(data = grac_np, aes(fill = paste(rate.type, Ambient_Nutrient, sep = " x ")), size = 1.75, position = position_dodge(0.5), show.legend = FALSE) +
  geom_smooth(data = grac_np, aes(fill = paste(rate.type, Ambient_Nutrient, sep = " x ")), se = TRUE, span = 0.9, alpha = 0.25, show.legend = FALSE) +
  geom_point(data = grac_r, aes(fill = paste(rate.type, Ambient_Nutrient, sep = " x ")), size = 1.75, position = position_dodge(0.5), show.legend = FALSE) +
  geom_smooth(data = grac_r, aes(fill = paste(rate.type, Ambient_Nutrient, sep = " x ")), se = TRUE, span = 0.7, linetype = "solid", show.legend = FALSE) +
  scale_fill_manual(values = c('seagreen2', 'seagreen', 'deepskyblue1', 'deepskyblue4')) +
  labs(x = "", y = expression(Rate~(log~mu*mol~O[2]~g^-1~hr^-1))) +
  theme_classic() +
  scale_x_continuous(limits = c(15, 43), expand = c(0, 0), breaks = seq(15, 40, by = 5)) +
  scale_y_continuous(expand = c(0, 0)) +
  scale_color_manual(values = c('seagreen2', 'seagreen', 'deepskyblue1', 'deepskyblue4'),
                     guide = guide_legend(title = "Treatment Type", title.position = "top", title.hjust = 0.5,
                                          override.aes = list(linetype = c("solid", "dashed", "solid", "dashed"),
                                                              fill = c('seagreen2', 'seagreen', 'deepskyblue1', 'deepskyblue4')),
                                          nrow = 2),
                     labels = c("Ambient Net Photosynthesis",
                                "Enriched Net Photosynthesis",
                                "Ambient Respiration",
                                "Enriched Respiration")) +
  theme(legend.text = element_text(size = 12),
        legend.title = element_text(size = 14), 
        axis.title.x = element_text(size = 20),
        axis.title.y = element_text(size = 20),
        axis.text.x = element_text(size =18, color = "black"), 
        axis.text.y = element_text(size = 18, color = "black"),
        plot.title = element_text(size = 23, face = "bold", hjust = -.2)) +
  ggtitle(expression(bold("a  ")~italic("Ochtodes")~plain("spp."))) +
  scale_y_continuous(limits = c(-0.96, 7), breaks = seq(0, 7, by = 1))

#Display the plot 
grac
```

##Plots for R and NP across all taxa
```{r}
library(gridExtra)
library(ggplot2)

# Arrange the plots in a grid
grid_NP_R <- grid.arrange(grac, pad, caul, ulv, ncol = 2)
```
